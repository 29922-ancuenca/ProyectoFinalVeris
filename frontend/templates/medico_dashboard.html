{% extends "base.html" %}
{% block title %}Módulo Médico - Proyecto VERIS{% endblock %}

{# Navbar específico para el módulo médico: solo usuario + logout #}
{% block nav %}
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-2">
  <div class="container-fluid px-4">
    <a class="navbar-brand d-flex flex-column align-items-start" href="{{ url_for('crud.index') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo Veris" class="img-fluid mb-1" style="height: 35px; width: auto;">
      <span class="slogan">Hacemos <strong>fácil cuidarte</strong></span>
    </a>

    <div class="d-flex flex-wrap ms-auto align-items-center mt-2 mt-lg-0">
      {% if session.get('user_name') %}
        {% if medico and medico.Foto %}
          <img src="{{ url_for('static', filename='img/usuarios/' ~ medico.Foto) }}" alt="{{ medico.Nombre }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
        {% endif %}
        <span class="navbar-text me-3 fw-semibold">{{ session['user_name'] }}</span>
        <a href="{{ url_for('crud.logout') }}" class="btn btn-primary btn-sm">Logout</a>
      {% endif %}
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<main class="container my-4">
  <h2 class="mb-1 text-primary">Módulo Médico</h2>
  <div class="alert alert-info alert-session-fixed py-2 small mb-3" data-no-autoclose="1">
    <strong>Sesión actual:</strong>
    Usuario = {{ session_info.user_name }},
    IdUsuario = {{ session_info.user_id }},
    Rol = {{ session_info.user_role }}
  </div>
  {% if medico %}
  <p class="mb-4 fw-semibold">Bienvenido, {{ medico.Nombre }}</p>
  {% else %}
  <p class="mb-4 fw-semibold">Bienvenido al módulo Médico</p>
  {% endif %}

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-datos" data-bs-toggle="tab" data-bs-target="#mis-datos" type="button" role="tab">Mis datos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-consultas" data-bs-toggle="tab" data-bs-target="#mis-consultas" type="button" role="tab">Mis consultas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-recetas" data-bs-toggle="tab" data-bs-target="#mis-recetas" type="button" role="tab">Mis recetas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-consultas-realizadas" data-bs-toggle="tab" data-bs-target="#consultas-realizadas" type="button" role="tab">Consultas realizadas</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="mis-datos" role="tabpanel" aria-labelledby="tab-datos">
      {% if medico %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            <tr><th>Nombre</th><td>{{ medico.Nombre }}</td></tr>
            <tr><th>Especialidad</th><td>{{ medico.NombreEspecialidad }}</td></tr>
            <tr>
              <th>Foto</th>
              <td>
                {% if medico.Foto %}
                  <img src="{{ url_for('static', filename='img/usuarios/' ~ medico.Foto) }}"
                       alt="{{ medico.Nombre }}"
                       class="img-thumbnail"
                       style="max-width: 120px; height: auto; object-fit: cover;"
                       onerror="this.style.display='none'">
                {% else %}
                  <span class="text-muted">Sin foto</span>
                {% endif %}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No se encontraron datos de médico vinculados a este usuario.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="mis-consultas" role="tabpanel" aria-labelledby="tab-consultas">
      {% if consultas %}
      {% set lcm = session.get('lista_consultas_medico', []) %}
      {% if lcm %}
      <div class="alert alert-info alert-session-fixed py-2 small mb-3" data-no-autoclose="1">
        <strong>Variable de sesión <code>lista_consultas_medico</code></strong>
        <pre class="mb-0">{{ lcm | tojson(indent=2) }}</pre>
      </div>
      {% endif %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Paciente</th>
              <th>Fecha</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Diagnóstico</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas %}
            <tr>
              <td>{{ c.NombrePaciente }}</td>
              <td>{{ c.FechaConsulta }}</td>
              <td>{{ c.HI }}</td>
              <td>{{ c.HF }}</td>
              <td>{{ c.Diagnostico }}</td>
              <td>
                {% if not c.Atendida %}
                  <a class="btn btn-sm btn-primary" href="{{ url_for('crud.atender_consulta', id_consulta=c.IdConsulta) }}">Atender</a>
                {% else %}
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('crud.siguiente_cita', id_consulta=c.IdConsulta) }}">Siguiente cita</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes consultas registradas.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="mis-recetas" role="tabpanel" aria-labelledby="tab-recetas">
      {% if recetas %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Fecha consulta</th>
              <th>Paciente</th>
              <th>Diagnóstico</th>
              <th>Medicamento</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recetas %}
            <tr>
              <td>{{ r.FechaConsulta }}</td>
              <td>{{ r.NombrePaciente }}</td>
              <td>{{ r.Diagnostico }}</td>
              <td>{{ r.NombreMedicamento }}</td>
              <td>{{ r.Cantidad }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes recetas registradas.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="consultas-realizadas" role="tabpanel" aria-labelledby="tab-consultas-realizadas">
      {% if consultas_realizadas %}
      <p class="mb-1"><strong>Médico en sesión:</strong>
        {% if medico %}{{ medico.Nombre }}{% else %}Desconocido{% endif %}
        (usuario: {{ session_info.user_name }})
      </p>
      <p class="text-muted">Listado de consultas realizadas con receta asignada.</p>
      {% set lcr_m = session.get('lista_consultas_realizadas', []) %}
      {% if lcr_m %}
      <div class="alert alert-info alert-session-fixed py-2 small mb-3" data-no-autoclose="1">
        <strong>Variable de sesión <code>lista_consultas_realizadas</code></strong>
        <pre class="mb-0">{{ lcr_m | tojson(indent=2) }}</pre>
      </div>
      {% endif %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Paciente</th>
              <th>Fecha</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Diagnóstico</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas_realizadas %}
            <tr>
              <td>{{ c.NombrePaciente }}</td>
              <td>{{ c.FechaConsulta }}</td>
              <td>{{ c.HI }}</td>
              <td>{{ c.HF }}</td>
              <td>{{ c.Diagnostico }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes consultas registradas.</p>
      {% endif %}
    </div>
  </div>
</main>
{% endblock %}
