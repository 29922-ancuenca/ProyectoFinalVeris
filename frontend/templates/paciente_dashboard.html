{% extends "base.html" %}
{% block title %}Módulo Paciente - Proyecto VERIS{% endblock %}

{# Navbar específico para el módulo paciente: solo usuario + logout #}
{% block nav %}
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-2">
  <div class="container-fluid px-4">
    <a class="navbar-brand d-flex flex-column align-items-start" href="{{ url_for('crud.index') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo Veris" class="img-fluid mb-1" style="height: 35px; width: auto;">
      <span class="slogan">Hacemos <strong>fácil cuidarte</strong></span>
    </a>

    <div class="d-flex flex-wrap ms-auto align-items-center mt-2 mt-lg-0">
      {% if session.get('user_name') %}
        {% if paciente and paciente.Foto %}
          <img src="{{ url_for('static', filename='img/usuarios/' ~ paciente.Foto) }}" alt="{{ paciente.Nombre }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
        {% endif %}
        <span class="navbar-text me-3 fw-semibold">{{ session['user_name'] }}</span>
        <a href="{{ url_for('crud.logout') }}" class="btn btn-primary btn-sm">Logout</a>
      {% endif %}
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<main class="container my-4">
  <h2 class="mb-1 text-primary">Módulo Paciente</h2>
  {% if paciente %}
  <p class="mb-4 fw-semibold">Bienvenido, {{ paciente.Nombre }}</p>
  {% else %}
  <p class="mb-4 fw-semibold">Bienvenido al módulo Paciente</p>
  {% endif %}

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-datos" data-bs-toggle="tab" data-bs-target="#mis-datos" type="button" role="tab">Mis datos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-consultas" data-bs-toggle="tab" data-bs-target="#mis-consultas" type="button" role="tab">Mis consultas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-recetas" data-bs-toggle="tab" data-bs-target="#mis-recetas" type="button" role="tab">Mis recetas</button>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="tab-agendar" href="{{ url_for('crud.agendar_cita') }}">Agendar citas</a>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-consultas-recibidas" data-bs-toggle="tab" data-bs-target="#consultas-recibidas" type="button" role="tab">Consultas recibidas</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="mis-datos" role="tabpanel" aria-labelledby="tab-datos">
      {% if paciente %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            <tr><th>Nombre</th><td>{{ paciente.Nombre }}</td></tr>
            <tr><th>Cédula</th><td>{{ paciente.Cedula }}</td></tr>
            <tr><th>Edad</th><td>{{ paciente.Edad }}</td></tr>
            <tr><th>Género</th><td>{{ paciente.Genero }}</td></tr>
            <tr><th>Estatura (cm)</th><td>{{ paciente["Estatura (cm)"] }}</td></tr>
            <tr><th>Peso (kg)</th><td>{{ paciente["Peso (kg)"] }}</td></tr>
            <tr>
              <th>Foto</th>
              <td>
                {% if paciente.Foto %}
                  <img src="{{ url_for('static', filename='img/usuarios/' ~ paciente.Foto) }}"
                       alt="{{ paciente.Nombre }}"
                       class="img-thumbnail"
                       style="max-width: 120px; height: auto; object-fit: cover;"
                       onerror="this.style.display='none'">
                {% else %}
                  <span class="text-muted">Sin foto</span>
                {% endif %}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No se encontraron datos de paciente vinculados a este usuario.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="mis-consultas" role="tabpanel" aria-labelledby="tab-consultas">
      {% if consultas %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Médico</th>
              <th>Fecha</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Diagnóstico</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas %}
            <tr>
              <td>{{ c.NombreMedico }}</td>
              <td>{{ c.FechaConsulta }}</td>
              <td>{{ c.HI }}</td>
              <td>{{ c.HF }}</td>
              <td>{{ c.Diagnostico }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes consultas registradas.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="mis-recetas" role="tabpanel" aria-labelledby="tab-recetas">
      {% if recetas %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Médico</th>
              <th>Fecha consulta</th>
              <th>Diagnóstico</th>
              <th>Medicamento</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recetas %}
            <tr>
              <td>{{ r.NombreMedico }}</td>
              <td>{{ r.FechaConsulta }}</td>
              <td>{{ r.Diagnostico }}</td>
              <td>{{ r.NombreMedicamento }}</td>
              <td>{{ r.Cantidad }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes recetas registradas.</p>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="consultas-recibidas" role="tabpanel" aria-labelledby="tab-consultas-recibidas">
      {% if consultas_recibidas %}
      <p class="text-muted">Listado de consultas recibidas con receta asignada.</p>
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Médico</th>
              <th>Fecha</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Diagnóstico</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consultas_recibidas %}
            <tr>
              <td>{{ c.NombreMedico }}</td>
              <td>{{ c.FechaConsulta }}</td>
              <td>{{ c.HI }}</td>
              <td>{{ c.HF }}</td>
              <td>{{ c.Diagnostico }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tienes consultas registradas.</p>
      {% endif %}
    </div>
  </div>
</main>
{% endblock %}
